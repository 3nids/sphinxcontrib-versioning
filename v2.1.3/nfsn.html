




<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-82627369-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>NearlyFreeSpeech.NET &mdash; sphinxcontrib-versioning</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/banner.css" type="text/css" />
  
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  

  
    <link rel="top" title="sphinxcontrib-versioning" href="index.html"/>
        <link rel="next" title="Changelog" href="changelog.html"/>
        <link rel="prev" title="GitHub Pages" href="github_pages.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> sphinxcontrib-versioning
          

          
          </a>

          
            
            
              <div class="version">
                2.1.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="banner.html">Banner Message</a></li>
<li class="toctree-l1"><a class="reference internal" href="settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="context.html">HTML Context API</a></li>
<li class="toctree-l1"><a class="reference internal" href="themes.html">Supported Themes</a></li>
</ul>
<p class="caption"><span class="caption-text">Web Hosting</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="github_pages.html">GitHub Pages</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">NearlyFreeSpeech.NET</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#running-in-ci">Running in CI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ssh-key">SSH Key</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#create-an-nfsn-site">Create an NFSN Site</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pushing-from-ci-to-nfsn">Pushing From CI to NFSN</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-rsync">Using Rsync</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-git-bare-repo">Using Git Bare Repo</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">sphinxcontrib-versioning</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 







<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>NearlyFreeSpeech.NET</li>
    <li class="wy-breadcrumbs-aside">
      
          
          
            <a href="https://github.com/Robpol86/sphinxcontrib-versioning/blob/v2.1.3/docs/nfsn.rst" class="fa fa-github"> Edit on GitHub</a>
          
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  


    
    



    <p class="scv-banner scv-sphinx_rtd_theme"><a href="../v2.1.4/nfsn.html"><b>Warning:</b> This document is for an old version of sphinxcontrib-versioning. The latest version is v2.1.4.</a></p>
<div class="section" id="nearlyfreespeech-net">
<span id="nfsn"></span><h1>NearlyFreeSpeech.NET<a class="headerlink" href="#nearlyfreespeech-net" title="Permalink to this headline">¶</a></h1>
<p>This guide will go over how to host your built documentation on <a class="reference external" href="https://www.nearlyfreespeech.net/">NFSN</a>. We&#8217;ll be
using GitHub and Travis CI to actually build the docs and push them to NFSN but any other providers can be substituted.</p>
<p>We&#8217;ll be covering two methods of having NFSN host your documentation: using <code class="docutils literal"><span class="pre">rsync</span></code> to transfer HTML files to NFSN and
using a remote git repository hosted on NFSN using <code class="docutils literal"><span class="pre">git</span> <span class="pre">init</span> <span class="pre">--bare</span></code> and having a git hook export HTML files to the
&#8220;/home/pubic&#8221; directory. Since NFSN&#8217;s pricing structure is usage based the latter method technically costs more since
the entire git history of the HTML files&#8217; git branch will be stored on NFSN, whereas in the rsync method only the HTML
files are stored on NFSN. The cost difference is probably minimal but it&#8217;s something to keep in mind.</p>
<p>Before starting be sure to go through the <a class="reference internal" href="tutorial.html#tutorial"><span class="std std-ref">Tutorial</span></a> first to make sure you can build your docs locally. If you&#8217;re
going with the <code class="docutils literal"><span class="pre">rsync</span></code> route you can stop after the <a class="reference internal" href="tutorial.html#build-all-versions"><span class="std std-ref">Build All Versions</span></a> section. Otherwise you should go through
the <a class="reference internal" href="tutorial.html#push-all-versions"><span class="std std-ref">Push All Versions</span></a> section as well.</p>
<p>This guide assumes:</p>
<ol class="arabic simple">
<li>You already have documentation in your master branch and SCVersioning builds it locally. If not you&#8217;ll need to use
the <a class="reference internal" href="settings.html#cmdoption--root-ref"><code class="xref std std-option docutils literal"><span class="pre">--root-ref</span></code></a> argument.</li>
<li>You already have Travis CI configured and running on your repo.</li>
<li>You already have an account on NFSN.</li>
</ol>
<div class="section" id="running-in-ci">
<h2>Running in CI<a class="headerlink" href="#running-in-ci" title="Permalink to this headline">¶</a></h2>
<p>Before touching NFSN let&#8217;s setup Travis CI to run SCVersioning. Edit your
<a class="reference external" href="https://docs.travis-ci.com/user/customizing-the-build/">.travis.yml</a> file with:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">addons</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">ssh_known_hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh.phx.nearlyfreespeech.net</span>
<span class="l l-Scalar l-Scalar-Plain">install</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install sphinxcontrib-versioning</span>
<span class="l l-Scalar l-Scalar-Plain">after_success</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sphinx-versioning build docs docs/_build/html</span>
</pre></div>
</div>
<p>Commit your changes and push. You should see documentation building successfully.</p>
<div class="section" id="ssh-key">
<h3>SSH Key<a class="headerlink" href="#ssh-key" title="Permalink to this headline">¶</a></h3>
<p>Now we need to create an SSH key pair and upload the private key to Travis CI. The public key will be given to NFSN in
the next section.</p>
<p>To avoid leaking the SSH private key (thereby granting write access to the repo) we&#8217;ll be using Travis CI&#8217;s
<a class="reference external" href="https://docs.travis-ci.com/user/encrypting-files/">Encrypting Files</a> feature. You&#8217;ll need to install the Travis CI
<a class="reference external" href="https://github.com/travis-ci/travis.rb#installation">ruby client</a> for this section.</p>
<p>Create the SSH key pair.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh-keygen -t rsa -b <span class="m">4096</span> -C <span class="s2">&quot;Travis CI Deploy Key&quot;</span> -N <span class="s2">&quot;&quot;</span> -f docs/key
cat docs/key.pub  <span class="c1"># We&#39;ll be adding this to NFSN&#39;s Add SSH Key page.</span>
travis encrypt-file docs/key docs/key.enc --add after_success  <span class="c1"># Updates .travis.yml</span>
rm docs/key docs/key.pub  <span class="c1"># Don&#39;t need these anymore.</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">travis</span> <span class="pre">encrypt-file</span></code> command should have updated your <code class="docutils literal"><span class="pre">.travis.yml</span></code> with the openssl command for you. However
we still need to make one more change to the file before committing it. Update .travis.yml to make the after_success
section look like the following. Remember to replace <strong>$encrypted_x_key</strong> and <strong>$encrypted_x_iv</strong> with what you
currently have.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">after_success</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">eval &quot;$(ssh-agent -s)&quot;; touch docs/key; chmod 0600 docs/key</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">openssl aes-256-cbc -d -K $encrypted_x_key -iv $encrypted_x_iv &lt; docs/key.enc &gt; docs/key</span>
    <span class="l l-Scalar l-Scalar-Plain">&amp;&amp; ssh-add docs/key</span>  <span class="c1"># Use &amp;&amp; to prevent ssh-add from prompting during pull requests.</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sphinx-versioning build docs docs/_build/html</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Always conditionally run ssh-add only if openssl succeeds like in the example above. Encrypted environment variables
are not set on Travis CI and probably other CIs during pull requests for security reasons. If you always run ssh-add
(which appears to be what everyone does) all of your pull requests will have failing tests because:</p>
<ol class="last arabic simple">
<li>Travis CI runs all commands in after_success even if one fails.</li>
<li>openssl appears to copy &#8220;key.enc&#8221; to &#8220;key&#8221; when it fails to decrypt.</li>
<li>ssh-add will prompt for a passphrase because it thinks the file is encrypted with an SSH passphrase.</li>
<li>The Travis job will hang, timeout, and fail even if tests pass.</li>
</ol>
</div>
<p>Finally commit both <strong>.travis.yml</strong> and the encrypted <strong>docs/key.enc</strong> file.</p>
</div>
</div>
<div class="section" id="create-an-nfsn-site">
<h2>Create an NFSN Site<a class="headerlink" href="#create-an-nfsn-site" title="Permalink to this headline">¶</a></h2>
<p>First we&#8217;ll create a static site on NFSN. Even if you&#8217;ve been using NFSN it&#8217;s a good idea to try this out in a dedicated
and disposable site to avoid breaking anything important.</p>
<ol class="arabic simple">
<li>Go to the <strong>sites</strong> tab in the member portal and click &#8220;Create a New Site&#8221;. This guide will use <strong>scversioning</strong> as
the new site&#8217;s short name.</li>
<li>Since this is all just static HTML files you won&#8217;t need PHP/MySQL/etc. Select the &#8220;Static Content&#8221; server type.</li>
<li>You should be able to visit <cite>http://scversioning.nfshost.com/</cite> and get an HTTP 403 error.</li>
<li>Go to the <strong>profile</strong> tab and click &#8220;Add SSH Key&#8221;. The key you&#8217;re pasting will be one long line and will look
something like &#8220;ssh-rsa AAAAB3N...== Travis CI Deploy Key&#8221;</li>
</ol>
</div>
<div class="section" id="pushing-from-ci-to-nfsn">
<h2>Pushing From CI to NFSN<a class="headerlink" href="#pushing-from-ci-to-nfsn" title="Permalink to this headline">¶</a></h2>
<p>This is the moment of truth. You need to decide if you want to just rsync HTML files from Travis CI to NFSN or add NFSN
as a git remote, have SCVersioning push to NFSN, and let a git hook on NFSN move HTML files to the web root.</p>
<div class="section" id="using-rsync">
<h3>Using Rsync<a class="headerlink" href="#using-rsync" title="Permalink to this headline">¶</a></h3>
<p>This is simpler and costs less (though probably not by much since NFSN is pretty cheap). All you need to do is add these
lines to your .travis.yml file&#8217;s <code class="docutils literal"><span class="pre">after_success</span></code> section. Be sure to replace username_scversioning with your
actual username and remove the previous sphinx-versioning line.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export destination=username_scversioning@ssh.phx.nearlyfreespeech.net:/home/public</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sphinx-versioning build docs docs/_build/html &amp;&amp; rsync -icrz --delete docs/_build/html/ $destination</span>
</pre></div>
</div>
<p>We&#8217;re adding rsync to the same line as sphinx-versioning because Travis CI runs all commands in after_success even if
one of them fails. No point in rsyncing if sphinx-versioning fails.</p>
<p>After committing you should see Travis CI rsync HTML files to NFSN and your site should be up and running with your
documentation.</p>
</div>
<div class="section" id="using-git-bare-repo">
<h3>Using Git Bare Repo<a class="headerlink" href="#using-git-bare-repo" title="Permalink to this headline">¶</a></h3>
<p>You can take advantage of SCVersioning&#8217;s git push retry logic if you go this route. Here we&#8217;ll be pushing build docs to
the <code class="docutils literal"><span class="pre">nfsn-pages</span></code> branch on the remote repo located in your NFSN&#8217;s private home directory.</p>
<p>First create the remote repo on NFSN. SSH into your new site and run these commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mkdir /home/private/repo
<span class="nb">cd</span> /home/private/repo
git init --bare
touch hooks/post-receive
chmod +x hooks/post-receive
</pre></div>
</div>
<p>Next setup the post-receive git hook. Write the following to <strong>/home/private/repo/hooks/post-receive</strong> on NFSN:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># !/bin/bash</span>
<span class="nb">export</span> <span class="nv">GIT_WORK_TREE</span><span class="o">=</span><span class="s2">&quot;/home/public&quot;</span>
<span class="k">while</span> <span class="nb">read</span> sha1old sha1new refname<span class="p">;</span> <span class="k">do</span>
    <span class="nv">branch</span><span class="o">=</span><span class="k">$(</span>git rev-parse --symbolic --abbrev-ref <span class="nv">$refname</span><span class="k">)</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$branch</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;nfsn-pages&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
    lockf -k -t5 /home/tmp/nfsn_pages.lock git checkout -f <span class="nv">$branch</span>
<span class="k">done</span>
</pre></div>
</div>
<p>Now before we move on to the final step you&#8217;ll need to create the initial commit to the nfsn-pages branch on the NFSN
remote. SCVersioning does not create new branches, they must previously exist on the remote. Here we&#8217;ll be renaming the
<code class="docutils literal"><span class="pre">gh-pages</span></code> branch you created in <a class="reference internal" href="tutorial.html#pushing-to-remote-branch"><span class="std std-ref">Pushing to Remote Branch</span></a> to <code class="docutils literal"><span class="pre">nfsn-pages</span></code> and pushing it to our new NFSN
remote repo. Run these commands on your local machine (replace username_scversioning with your actual username):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git push origin --delete gh-pages  <span class="c1"># No longer need this in origin.</span>
git checkout gh-pages
git branch -m nfsn-pages
git remote add nfsn <span class="s2">&quot;username_scversioning@ssh.phx.nearlyfreespeech.net:/home/private/repo&quot;</span>
git push nfsn nfsn-pages
</pre></div>
</div>
<p>At this point you should see .gitignore and README.rst in your /home/public directory on NFSN. Finally add these lines
to your .travis.yml file&#8217;s <code class="docutils literal"><span class="pre">after_success</span></code> section. Be sure to replace username_scversioning with your actual username
and remove the previous sphinx-versioning line.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git config --global user.email &quot;builds@travis-ci.com&quot;</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git config --global user.name &quot;Travis CI&quot;</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git remote add nfsn &quot;username_scversioning@ssh.phx.nearlyfreespeech.net:/home/private/repo&quot;</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export ${!TRAVIS*}</span>  <span class="c1"># Optional, for commit messages.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sphinx-versioning push -P nfsn docs nfsn-pages .</span>
</pre></div>
</div>
<p>After committing you should see Travis CI push HTML files to NFSN and your site should be up and running with your
documentation.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="changelog.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="github_pages.html" class="btn btn-neutral" title="GitHub Pages" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, @Robpol86.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: v2.1.3
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../v2.1.4/nfsn.html">v2.1.4</a></dd>
            <dd><a href="nfsn.html">v2.1.3</a></dd>
            <dd><a href="../v2.1.2/index.html">v2.1.2</a></dd>
            <dd><a href="../v2.1.1/index.html">v2.1.1</a></dd>
            <dd><a href="../v2.1.0/index.html">v2.1.0</a></dd>
            <dd><a href="../v2.0.0/index.html">v2.0.0</a></dd>
            <dd><a href="../v1.1.0/index.html">v1.1.0</a></dd>
            <dd><a href="../v1.0.1/index.html">v1.0.1</a></dd>
            <dd><a href="../v1.0.0/index.html">v1.0.0</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../codecov/nfsn.html">codecov</a></dd>
            <dd><a href="../master/nfsn.html">master</a></dd>
        </dl>
    </div>
</div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.1.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  false
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>